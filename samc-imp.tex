\section{Implementation and Integration}
\label{sec-samc-impl}

In this section, we first describe our SAMC prototype, \sampro, which we
built from scratch because existing dmcks are either
proprietary~\cite{Yang+09-Modist} or only work on restricted high-level
languages (\eg, Mace~\cite{Killian+07-LifeDeathMaceMC}).  We will then describe
\sampro\ integration to three widely popular cloud systems,
ZooKeeper~\cite{Hunt+10-ZooKeeperPaper}, Hadoop/Yarn~\cite{Kumar+13-Yarn},
and Cassandra~\cite{Lakshman+09-Cassandra}.  Prior to \sampro, there was no
available dmck for these systems; they are still tested via unit tests, and
the test code size is bigger than the main code, but the tests are far from
reaching deep bugs.


\subsection{\sampro}
\label{imp-pro}

\sampro\ is written in \numLinesSamPro\ lines of code in Java, which
includes all the components mentioned in Section~\ref{mot-bgterms} and
Figure~\ref{fig-dmck}.  The detailed anatomy of dmck has been
thoroughly explained in literature~\cite{Guerraoui+11-McNoNetwork,
  Guo+11-Demeter, Killian+07-LifeDeathMaceMC, Simsa+10-Dbug,
  Yang+09-Modist}, and therefore for brevity, we will not discuss many
engineering details.  We will focus on SAMC-related parts.

% access source code
We design \sampro\ to be highly portable; we do not modify the target code
base significantly as we leverage a mature interposition technology,
AspectJ, for interposing network messages and timeouts.
% local state
Our interposition layer also sends local state information to the
\sampro\ server.
% crashes and reboots
\sampro\ is also equipped with crash and reboot scripts specific to the
target systems.  The tester can specify a budget of the maximum number of
crashes and reboots to inject per execution.
% summ
\sampro\ employs basic reduction mechanisms and advanced reduction policies
as described before.
% checks
We deploy safety checks at the server (\eg, no two leaders).  If a
check is violated, the trace that led to the bug is reported and 
can be deterministically replayed in \sampro.
% other supports
Overall, we have built all the necessary features to show the case of
SAMC.  Other features such as intra-node thread
interleavings~\cite{Guo+11-Demeter}, scale-out
parallelism~\cite{Simsa+12-ScalablePOR}, and virtual clock for network
delay~\cite{Yang+09-Modist} can be integrated to \sampro\ as well.


\vten % orphan text

\subsection{Integration to Target Systems}
\label{imp-targets}


In our work, the target systems are ZooKeeper, Hadoop 2.0/Yarn, and
Cassandra.  ZooKeeper~\cite{Hunt+10-ZooKeeperPaper} is a distributed
synchronization service acting as a backbone of many distributed systems
such as HBase and High-Availability HDFS.  Hadoop
2.0/Yarn~\cite{Kumar+13-Yarn} is the current generation of Hadoop that
separates cluster management and processing components.
Cassandra~\cite{Lakshman+09-Cassandra} is a distributed key-value store
derived from Amazon Dynamo~\cite{DeCandia+07-Dynamo}.

In total, we have model checked \numProtocols\ protocols: ZooKeeper
leader election (ZLE) and atomic broadcast (ZAB), Hadoop cluster
management (CM) and speculative execution (SE), and Cassandra
read/write (RW), hinted handoff (HH) and gossiper (GS).  These
protocols are highly asynchronous and thus susceptible to message
re-orderings and failures.

Table~\ref{tab-policies} shows a real sample of protocol-specific
rules that we wrote.  Rules are in general very short; we only wrote
\numLinesRule\ lines/protocol on average.  This shows the simplicity
of SAMC's integration to a wide variety of distributed system protocols.

\input{tab-policies}

